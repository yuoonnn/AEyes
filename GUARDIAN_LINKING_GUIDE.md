# Guardian Linking Guide

This guide explains how the guardian-user linking system works in the AEyes app.

## Overview

The linking system allows users to connect with guardians who can monitor their safety data. The linking process involves:

1. **User creates a link request** - A user adds a guardian by email
2. **Guardian approves the request** - The guardian logs in and approves pending requests
3. **Active link established** - Once approved, guardians can view linked user data

## Data Structure

### Guardians Collection (`/guardians/{guardianId}`)

Each document represents a link between a user and a guardian:

```javascript
{
  guardian_id: "random_id",
  user_id: "user_uid",              // The user being monitored
  guardian_email: "guardian@email.com",  // Normalized to lowercase
  guardian_name: "Guardian Name",
  phone: "optional_phone",
  relationship_status: "pending" | "active",  // Starts as "pending"
  created_at: Timestamp,
  approved_at: Timestamp  // Set when guardian approves
}
```

### Key Points:
- **Document ID**: Random (generated by Firestore)
- **Email Matching**: Guardian emails are normalized to lowercase for consistent matching
- **Status Flow**: `pending` → `active` (when guardian approves)

## Linking Flow

### Step 1: User Creates Link Request

When a user wants to link a guardian:

```dart
await databaseService.linkGuardian(
  guardianEmail: "guardian@email.com",
  guardianName: "Guardian Name",
);
```

This creates a document in `/guardians` with:
- `user_id`: Current user's UID
- `guardian_email`: Normalized email (lowercase)
- `relationship_status`: "pending"

### Step 2: Guardian Queries for Pending Requests

When a guardian logs in, the app queries for pending requests:

```dart
final pending = await databaseService.getPendingLinkRequests(guardianEmail);
```

This queries `/guardians` collection:
```dart
.where('guardian_email', isEqualTo: normalizedEmail)
.where('relationship_status', isEqualTo: 'pending')
```

### Step 3: Guardian Approves Request

Guardian clicks "Approve" on a pending request:

```dart
await databaseService.approveLinkRequest(guardianId);
```

This updates the guardian document:
```dart
{
  'relationship_status': 'active',
  'approved_at': Timestamp
}
```

### Step 4: Guardian Views Linked Users

After approval, guardian can see linked users:

```dart
final users = await databaseService.getLinkedUsersForGuardian(guardianEmail);
```

This queries `/guardians` collection:
```dart
.where('guardian_email', isEqualTo: normalizedEmail)
.where('relationship_status', isEqualTo: 'active')
```

Then fetches user profiles from `/users/{userId}` for each linked user.

## Firestore Security Rules

### Guardians Collection

```javascript
match /guardians/{guardianId} {
  // Users can read/write guardians linked to them (by user_id)
  // Guardians can read guardians where guardian_email matches their email
  allow read: if isAuthenticated() && (
    resource.data.user_id == request.auth.uid ||
    (resource.data.guardian_email != null && 
     resource.data.guardian_email.toLowerCase() == request.auth.token.email.toLowerCase())
  );
  
  allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
  
  // Guardians can update to approve requests
  allow update: if isAuthenticated() && (
    resource.data.user_id == request.auth.uid ||
    (resource.data.guardian_email != null && 
     resource.data.guardian_email.toLowerCase() == request.auth.token.email.toLowerCase())
  );
  
  allow delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
}
```

**Key Points:**
- Users can read/write guardians where `user_id` matches their UID
- Guardians can read/update guardians where `guardian_email` matches their email
- This allows `.where()` queries to work correctly

### Users Collection

```javascript
match /users/{userId} {
  // Allow read: user owns it OR any authenticated user
  // App logic ensures only linked users are accessed
  allow read: if isOwner(userId) || isAuthenticated();
  allow create: if isOwner(userId);
  allow update: if isOwner(userId);
  allow delete: if isOwner(userId);
}
```

**Key Points:**
- Any authenticated user can read user profiles
- App logic (querying guardians collection first) ensures only linked users are accessed
- Users can only create/update/delete their own profile

## Common Issues and Solutions

### Issue 1: Permission Denied When Loading Profile

**Symptom**: Error "permission-denied" when guardian tries to load their profile.

**Solution**: 
1. Ensure Firestore rules are deployed: `firebase deploy --only firestore:rules`
2. Verify guardian is authenticated: Check `FirebaseAuth.instance.currentUser`
3. Check that guardian's profile exists in `/users/{guardianUid}` collection

### Issue 2: No Pending Requests Found

**Symptom**: Guardian dashboard shows no pending requests even though user created one.

**Possible Causes:**
1. **Email Mismatch**: Email in guardian document doesn't match guardian's auth email
   - Check: Email is normalized to lowercase in both places
   - Verify: `guardianEmail.trim().toLowerCase()` matches `request.auth.token.email.toLowerCase()`

2. **Rules Not Deployed**: Firestore rules haven't been deployed
   - Solution: Deploy rules with `firebase deploy --only firestore:rules`

3. **Status Mismatch**: Document status is not "pending"
   - Check: `relationship_status` field in Firestore console

### Issue 3: No Linked Users After Approval

**Symptom**: Guardian approves request but still sees "No linked users".

**Possible Causes:**
1. **Status Not Updated**: `relationship_status` wasn't changed to "active"
   - Check: Verify `approveLinkRequest()` successfully updates the document

2. **Email Case Sensitivity**: Email matching fails due to case differences
   - Solution: Ensure emails are normalized to lowercase everywhere

3. **Query Fails**: Firestore query doesn't return results
   - Check: Verify query in Firestore console manually

## Testing the Linking Flow

### Test as User:
1. Log in as a user
2. Go to Profile → Link Guardian
3. Enter guardian email and name
4. Submit (creates pending request)

### Test as Guardian:
1. Log in as guardian (using the email from step 3)
2. Open Guardian Dashboard
3. Should see pending request
4. Click "Approve"
5. Should now see linked user in dashboard

### Verify in Firestore Console:
1. Check `/guardians` collection:
   - Should see document with `user_id`, `guardian_email`, `relationship_status`
2. Check `/users` collection:
   - Should see user profile and guardian profile (if guardian created one)

## Debugging Tips

1. **Enable Debug Logging**: Check console logs for:
   - Email normalization: `print('Normalized email: $normalizedEmail')`
   - Query results: `print('Found ${snapshot.docs.length} results')`
   - User IDs: `print('User ID: $userId')`

2. **Check Firestore Console**: Manually verify:
   - Guardian documents exist
   - Email fields match (case-insensitive)
   - Status fields are correct

3. **Test Queries Manually**: In Firestore console, try:
   ```
   Collection: guardians
   Filter: guardian_email == "guardian@email.com"
   Filter: relationship_status == "active"
   ```

## Best Practices

1. **Always Normalize Emails**: Use `.trim().toLowerCase()` on all email inputs
2. **Handle Null Cases**: Check for null emails before querying
3. **Error Handling**: Wrap queries in try-catch and provide user-friendly error messages
4. **Status Management**: Always check `relationship_status` before allowing access
5. **Deploy Rules**: Always deploy Firestore rules after making changes

